<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Konarak F&B Dry Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* ========== GLOBAL UI STYLES (UI STYLE A) ========== */
:root{
  --blue:#005bbb;
  --muted:#666;
  --card:#fff;
  --bg:#f4f6f8;
  --border:#dcdcdc
}
*{box-sizing:border-box;}
body{
  margin:0;background:var(--bg);
  font-family:Arial,Helvetica,sans-serif;color:#222;
}
.wrap{max-width:1100px;margin:0 auto;padding:12px;}
.card{
  background:#fff;padding:14px;border-radius:8px;
  margin-bottom:12px;border:1px solid var(--border);
  box-shadow:0 2px 10px rgba(0,0,0,.05);
}
label{font-size:13px;font-weight:600;color:var(--muted);}
input,select{
  width:100%;padding:10px;margin-top:6px;border:1px solid var(--border);
  border-radius:6px;font-size:14px;
}
button{
  background:var(--blue);color:#fff;font-weight:700;border:0;
  border-radius:6px;padding:10px 14px;cursor:pointer;margin-top:10px;
}
.hidden{display:none;}
.table-wrapper{overflow:auto;margin-top:10px;}
table{border-collapse:collapse;width:100%;font-size:13px;}
th,td{border:1px solid #ccc;padding:6px;}
.logo{width:60px;height:auto;}
.header{
  display:flex;align-items:center;gap:10px;margin-bottom:10px;
}

/* Sidebar */
#adminPage {display:flex;}
.sidebar{
  width:220px;min-height:100vh;background:#fff;padding:12px;
  border-right:1px solid var(--border);
}
.sidebar button{width:100%;margin-bottom:8px;}

/* Main admin area */
.main{flex:1;padding:12px;}
</style>
</head>
<body>

<div id="loginPage" class="wrap">
  <div class="header">
    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg" class="logo">
    <h2>Konarak F&B ‚Äî Dry Store Login</h2>
  </div>

  <div class="card">
    <label>Email</label>
    <input id="loginEmail" type="email">

    <label>Password</label>
    <input id="loginPassword" type="password">

    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<!-- ============================================================
=                         ADMIN PAGE                           =
============================================================ -->
<div id="adminPage" class="hidden">

  <div class="sidebar">
    <button onclick="showAdminSection('homeSection')">üè† Home</button>
    <button onclick="showAdminSection('buildSection')">üè¢ Buildings</button>
    <button onclick="showAdminSection('floorSection')">üìö Floors</button>
    <button onclick="showAdminSection('counterSection')">üéØ Counters</button>
    <button onclick="showAdminSection('userSection')">üë• Users</button>
    <button onclick="showAdminSection('dataSection')">üìÑ Data</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="main">
    <h2 id="adminTitle">Admin Dashboard</h2>

    <!-- HOME -->
    <div id="homeSection" class="card">
      <h3>Welcome Admin</h3>
      <p>Use left menu to manage Konarak Dry Store System.</p>
    </div>

    <!-- BUILDINGS -->
    <div id="buildSection" class="card hidden">
      <h3>Buildings</h3>
      <input id="buildingName" placeholder="Building Name">
      <button onclick="createBuilding()">Add Building</button>
      <div id="buildingList"></div>
    </div>

    <!-- FLOORS -->
    <div id="floorSection" class="card hidden">
      <h3>Floors</h3>
      <select id="floorBuilding"></select>
      <input id="floorName" placeholder="Floor Name">
      <button onclick="createFloor()">Add Floor</button>
      <div id="floorList"></div>
    </div>

    <!-- COUNTERS -->
    <div id="counterSection" class="card hidden">
      <h3>Counters</h3>
      <select id="counterBuilding"></select>
      <select id="counterFloor"></select>
      <input id="counterName" placeholder="Counter Name">
      <button onclick="createCounter()">Add Counter</button>
      <div id="counterList"></div>
    </div>

    <!-- USERS -->
    <div id="userSection" class="card hidden">
      <h3>Create Users</h3>
      <input id="userEmail" placeholder="Email">
      <input id="userPassword" placeholder="Password">

      <select id="userBuilding"></select>
      <select id="userFloor"></select>
      <select id="userCounter"></select>
      <select id="userRole">
        <option value="admin">Admin</option>
        <option value="staff">Staff</option>
      </select>

      <button onclick="createUser()">Create User</button>
      <div id="userList"></div>
    </div>

    <!-- DATA PANEL -->
    <div id="dataSection" class="card hidden">
      <h3>Data Export</h3>

      <select id="filterBuilding"></select>
      <select id="filterFloor"></select>
      <select id="filterCounter"></select>

      <input id="fromDate" type="date">
      <input id="toDate" type="date">

      <button onclick="filterData()">Load</button>
      <button onclick="downloadPDF()">PDF</button>
      <button onclick="downloadExcel()">Excel</button>

      <div id="dataTable" class="table-wrapper"></div>
    </div>

  </div>
</div>


<!-- ============================================================
=                         STAFF PAGE                           =
============================================================ -->
<div id="staffPage" class="wrap hidden">
  <div class="header">
    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg" class="logo">
    <h2>Staff ‚Äî Add Dry Store Entry</h2>
    <button style="margin-left:auto" onclick="logout()">Logout</button>
  </div>

  <div class="card">
    <h3>Your Counter</h3>
    <input id="staffBuilding" disabled>
    <input id="staffFloor" disabled>
    <input id="staffCounter" disabled>
  </div>

  <div class="card">
    <h3>Add Entry</h3>

    <label>Item</label><input id="i_item">

    <label>Batch No</label><input id="i_batch">

    <label>Receiving Date</label><input id="i_rec" type="date">

    <label>Manufacturing Date</label><input id="i_mfg" type="date">

    <label>Expiry Date</label><input id="i_exp" type="date">

    <label>Shelf Life</label><input id="i_shelf">

    <label>Quantity</label><input id="i_qty">

    <label>Remarks</label><input id="i_rem">

    <button onclick="saveEntry()">Save Entry</button>
  </div>

  <div class="card">
    <h3>Last 7 Days Entries</h3>
    <div id="staffEntries" class="table-wrapper"></div>
  </div>
</div>

<!-- ============================================================
=                         FIREBASE + LOGIC                      =
============================================================ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ============================================================
   REAL FIREBASE CONFIG (YOURS)
============================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyDFBaRe6jDJwbSoRMpGZiQUB8PNXak0o8E",
  authDomain: "konarak-dry-store.firebaseapp.com",
  projectId: "konarak-dry-store",
  storageBucket: "konarak-dry-store.firebasestorage.app",
  messagingSenderId: "796844296062",
  appId: "1:796844296062:web:addf9694564505f914552f"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();


/* ============================================================
   LOGIN
============================================================ */
function login(){
  var email = loginEmail.value;
  var pass  = loginPassword.value;

  auth.signInWithEmailAndPassword(email, pass)
  .then(async (res)=>{

    let uid = res.user.uid;
    let doc = await db.collection("users").doc(uid).get();

    if(!doc.exists){ loginError.innerHTML="User not found"; return; }

    let role = doc.data().role;

    if(role=="admin"){
      loginPage.classList.add("hidden");
      adminPage.classList.remove("hidden");
      loadAllAdminDropdowns();
    }else{
      loginPage.classList.add("hidden");
      staffPage.classList.remove("hidden");
      loadStaffInfo(uid);
    }
  })
  .catch(e=>loginError.innerHTML=e.message);
}

function logout(){
  auth.signOut().then(()=>{
    location.reload();
  });
}

/* ============================================================
   ADMIN SECTIONS SWITCH
============================================================ */
function showAdminSection(id){
  ["homeSection","buildSection","floorSection","counterSection","userSection","dataSection"]
    .forEach(sec=>document.getElementById(sec).classList.add("hidden"));

  document.getElementById(id).classList.remove("hidden");
}

/* ============================================================
   BUILDINGS CRUD
============================================================ */
async function createBuilding(){
  let name = buildingName.value.trim();
  if(!name) return;
  await db.collection("buildings").add({name});
  loadAllAdminDropdowns();
}

async function createFloor(){
  await db.collection("floors").add({
    building: floorBuilding.value,
    name: floorName.value
  });
  loadAllAdminDropdowns();
}

async function createCounter(){
  await db.collection("counters").add({
    building: counterBuilding.value,
    floor: counterFloor.value,
    name: counterName.value
  });
  loadAllAdminDropdowns();
}

/* ============================================================
   LOAD DROPDOWNS FOR ADMIN
============================================================ */
async function loadAllAdminDropdowns(){
  let b = await db.collection("buildings").get();
  let f = await db.collection("floors").get();
  let c = await db.collection("counters").get();

  function fill(sel, list, field){
    sel.innerHTML="";
    list.forEach(d=> sel.innerHTML+=`<option>${d.data()[field]}</option>`);
  }

  fill(floorBuilding, b.docs, "name");
  fill(counterBuilding, b.docs, "name");
  fill(counterFloor, f.docs, "name");

  fill(userBuilding, b.docs, "name");
  fill(userFloor, f.docs, "name");
  fill(userCounter, c.docs, "name");

  fill(filterBuilding, b.docs, "name");
  fill(filterFloor, f.docs, "name");
  fill(filterCounter, c.docs, "name");
}

/* ============================================================
   CREATE USER
============================================================ */
async function createUser(){
  let email = userEmail.value;
  let pass  = userPassword.value;
  let role  = userRole.value;

  let building = userBuilding.value;
  let floor    = userFloor.value;
  let counter  = userCounter.value;

  let res = await fetch(
    `https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`,
    {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({email:email,password:pass,returnSecureToken:true})
    }
  );

  let json = await res.json();

  if(json.error){ alert("Auth error"); return; }

  await db.collection("users").doc(json.localId).set({
    email, role, building, floor, counter,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("User created");
}

/* ============================================================
   STAFF PAGE LOGIC
============================================================ */
async function loadStaffInfo(uid){
  let res = await db.collection("users").doc(uid).get();
  let u = res.data();

  staffBuilding.value = u.building;
  staffFloor.value    = u.floor;
  staffCounter.value  = u.counter;

  loadStaffEntries(uid);
}

/* SAVE ENTRY */
async function saveEntry(){
  let uid = auth.currentUser.uid;

  let udoc = await db.collection("users").doc(uid).get();
  let u = udoc.data();

  let entry = {
    createdBy: uid,
    building: u.building,
    floor: u.floor,
    counter: u.counter,
    date: new Date().toISOString().slice(0,10),
    rows: [{
      item: i_item.value,
      batch: i_batch.value,
      receiving: i_rec.value,
      mfg: i_mfg.value,
      exp: i_exp.value,
      shelf: i_shelf.value,
      qty: i_qty.value,
      remarks: i_rem.value
    }],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("entries").add(entry);
  loadStaffEntries(uid);
  alert("Saved");
}

/* SHOW LAST 7 DAYS */
async function loadStaffEntries(uid){
  let snap = await db.collection("entries")
    .where("createdBy","==",uid)
    .orderBy("timestamp","desc")
    .get();

  let table = `<table><tr>
    <th>Date</th><th>Item</th><th>Batch</th><th>Rec</th>
    <th>Mfg</th><th>Exp</th><th>Shelf</th><th>Qty</th><th>Remarks</th>
  </tr>`;

  snap.forEach(d=>{
    let e = d.data();
    let r = e.rows[0];

    table += `<tr>
      <td>${e.date}</td>
      <td>${r.item}</td>
      <td>${r.batch}</td>
      <td>${r.receiving}</td>
      <td>${r.mfg}</td>
      <td>${r.exp}</td>
      <td>${r.shelf}</td>
      <td>${r.qty}</td>
      <td>${r.remarks}</td>
    </tr>`;
  });

  table += "</table>";
  staffEntries.innerHTML = table;
}

/* ============================================================
   ADMIN DATA EXPORT
============================================================ */
let loadedRows = [];

async function filterData(){
  let b = filterBuilding.value;
  let f = filterFloor.value;
  let c = filterCounter.value;

  let from = fromDate.value;
  let to   = toDate.value;

  let q = db.collection("entries").orderBy("timestamp","desc");

  let snap = await q.get();
  loadedRows = [];

  snap.forEach(e=>{
    let d = e.data();
    let r = d.rows[0];

    if(d.building==b && d.floor==f && d.counter==c){
      if((!from || d.date>=from) && (!to || d.date<=to)){
        loadedRows.push({
          Date: d.date,
          Item: r.item,
          Batch: r.batch,
          Receiving: r.receiving,
          Mfg: r.mfg,
          Exp: r.exp,
          Shelf: r.shelf,
          Qty: r.qty,
          Remarks: r.remarks
        });
      }
    }
  });

  renderTable();
}

function renderTable(){
  if(loadedRows.length===0){
    dataTable.innerHTML="No data";
    return;
  }

  let keys = Object.keys(loadedRows[0]);
  let html = "<table><tr>";

  keys.forEach(k=>html+=`<th>${k}</th>`);
  html+="</tr>";

  loadedRows.forEach(r=>{
    html+="<tr>";
    keys.forEach(k=>html+=`<td>${r[k]}</td>`);
    html+="</tr>";
  });

  html+="</table>";
  dataTable.innerHTML = html;
}

/* PDF EXPORT */
async function downloadPDF(){
  if(loadedRows.length===0){ alert("No data"); return; }

  let temp = document.createElement("div");
  temp.style.width="1122px";
  temp.innerHTML="<h2>Dry Store Export</h2>"+dataTable.innerHTML;
  document.body.appendChild(temp);

  const canvas = await html2canvas(temp,{scale:2});
  const img = canvas.toDataURL("image/png");

  const pdf = new jspdf.jsPDF({orientation:'landscape',unit:'pt',format:'a4'});
  pdf.addImage(img,'PNG',0,0,pdf.internal.pageSize.getWidth(),pdf.internal.pageSize.getHeight());
  pdf.save("export.pdf");

  temp.remove();
}

/* EXCEL EXPORT */
function downloadExcel(){
  if(loadedRows.length===0){ alert("No data"); return; }
  const ws = XLSX.utils.json_to_sheet(loadedRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
  XLSX.writeFile(wb, "export.xlsx");
}

</script>
</body>
</html>
