<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dry Store Inventory — Mobile First</title>

  <!-- jsPDF + AutoTable for CTS PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Mobile-first design */
    :root{
      --accent: #0b74de;
      --muted: #666;
      --bg: #f6f8fb;
      --card: #ffffff;
      --max-width: 1100px;
      --radius: 10px;
      --gap: 12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
    header{display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-bottom:1px solid #eee;position:sticky;top:0;z-index:20}
    .hdr-left{display:flex;gap:12px;align-items:center}
    .hdr-logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(90deg,var(--accent),#00b4ff);display:inline-block}
    .hdr-title{font-weight:600}
    .hdr-sub{font-size:12px;color:var(--muted)}
    .auth-area{margin-left:auto;font-size:13px}

    .container{max-width:var(--max-width);margin:14px auto;padding:12px}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 2px 8px rgba(20,20,20,0.04);margin-bottom:14px}

    h1{font-size:18px;margin:6px 0}
    h2{font-size:16px;margin:6px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea,button{font-family:inherit}
    input,select,textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600}
    button.btn-ghost{background:transparent;border:1px solid #ddd;color:#333}

    .grid{display:grid;gap:var(--gap)}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .flex{display:flex;gap:8px;align-items:center}

    /* Mobile specific: stack everything and make buttons full-width */
    @media (max-width:720px){
      .two-col{grid-template-columns:1fr}
      .controls{flex-direction:column}
      button{width:100%}
    }

    /* Table wrapper for horizontal scrolling */
    .table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:8px;border:1px solid #f0f0f0}
    table{border-collapse:collapse;min-width:900px;width:100%}
    th,td{padding:8px;border:1px solid #eee;text-align:left;font-size:13px}
    th{background:#fafafa}

    /* Responsive form layout for larger screens */
    @media (min-width:900px){
      .form-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .form-3col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
      .fixed-sidebar{display:grid;grid-template-columns:240px 1fr;gap:12px}
    }

    /* Small helpers */
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .right{margin-left:auto}
    .nowrap{white-space:nowrap}
  </style>
</head>

<body>
  <header>
    <div class="hdr-left">
      <img id="hdrLogo" class="hdr-logo" alt="logo"/>
      <div>
        <div class="hdr-title">Dry Store Inventory</div>
        <div class="hdr-sub">Buildings → Floors → Counters → Staff</div>
      </div>
    </div>
    <div id="authArea" class="auth-area"></div>
  </header>

  <main class="container">

    <!-- LOGIN -->
    <section id="page-login" class="card">
      <h1>Sign in</h1>
      <form id="loginForm" class="grid" autocomplete="on">
        <label>Email <input id="loginEmail" type="email" required /></label>
        <label>Password <input id="loginPassword" type="password" required /></label>
        <div class="controls">
          <button type="submit">Sign in</button>
        </div>
        <div class="small">Create an Auth user in Firebase Console and seed the users/{uid} document.</div>
      </form>
    </section>

    <!-- STAFF (hidden by default) -->
    <section id="page-staff" class="card hide">
      <div class="fixed-sidebar">
        <aside class="card small">
          <h3>Staff</h3>
          <div class="muted">Add entries. You will see only the last 7 days. No download for staff users.</div>
          <div style="margin-top:12px" id="staffAssignedInfo"></div>
        </aside>

        <div>
          <h1>Dry Store Entry</h1>
          <form id="entryForm" class="grid card">
            <div class="form-2col">
              <label>Item <input name="item" required></label>
              <label>Batch No <input name="batchNo" required></label>
            </div>

            <div class="form-3col">
              <label>Receiving Date <input type="date" name="receivingDate" required></label>
              <label>Mfg Date <input type="date" name="mfgDate"></label>
              <label>Expiry Date <input type="date" name="expiryDate"></label>
            </div>

            <div class="form-2col">
              <label>Shelf Life (days) <input type="number" name="shelfLife"></label>
              <label>Stock Qty <input type="number" name="stockQty" required></label>
            </div>

            <label>Remarks <textarea name="remarks"></textarea></label>

            <div class="controls">
              <button type="submit">Save</button>
              <button id="btnReset" type="button" class="btn-ghost">Clear</button>
            </div>
          </form>

          <h2>Recent (7 days)</h2>
          <div class="card table-wrap">
            <table id="staffTable" aria-label="Staff recent entries">
              <thead>
                <tr><th>S.No</th><th>Item</th><th>Batch</th><th>Receiving</th><th>Mfg</th><th>Expiry</th><th>Shelf</th><th>Qty</th><th>Remarks</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- MANAGER (hidden by default) -->
    <section id="page-manager" class="card hide">
      <h1>Manager — Data</h1>
      <div class="card grid">
        <div class="two-col">
          <label>From <input id="mgrFrom" type="date"></label>
          <label>To <input id="mgrTo" type="date"></label>
        </div>
        <div class="controls">
          <button id="mgrView">View</button>
          <button id="mgrCSV" class="btn-ghost">Export CSV</button>
          <button id="mgrCTS" class="btn-ghost">Export CTS PDF</button>
        </div>
      </div>

      <div class="card table-wrap">
        <table id="mgrTable" aria-label="Manager entries">
          <thead>
            <tr><th>S.No</th><th>Item</th><th>Batch</th><th>Receiving</th><th>Mfg</th><th>Expiry</th><th>Shelf</th><th>Qty</th><th>Remarks</th><th>By</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ADMIN (hidden by default) -->
    <section id="page-admin" class="card hide">
      <h1>Admin Panel</h1>

      <div class="card grid">
        <div class="two-col">
          <label>Building <select id="admBuilding"></select></label>
          <label>Floor <select id="admFloor"></select></label>
        </div>
        <div class="two-col">
          <label>Counter <select id="admCounter"></select></label>
          <div class="flex">
            <label>From <input id="admFrom" type="date"></label>
            <label>To <input id="admTo" type="date"></label>
          </div>
        </div>

        <div class="controls">
          <button id="admView">View</button>
          <button id="admCSV" class="btn-ghost">Export CSV</button>
          <button id="admCTS" class="btn-ghost">Export CTS PDF</button>
        </div>
      </div>

      <div class="card table-wrap">
        <table id="admTable" aria-label="Admin entries table">
          <thead>
            <tr><th>S.No</th><th>Item</th><th>Batch</th><th>Receiving</th><th>Mfg</th><th>Expiry</th><th>Shelf</th><th>Qty</th><th>Remarks</th><th>By</th><th>B</th><th>F</th><th>C</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h2>Infrastructure & Users</h2>
      <div class="card grid">
        <div>
          <h3>Create Building</h3>
          <input id="newBuilding" placeholder="Building name">
          <button id="createBuilding">Add Building</button>
        </div>

        <div>
          <h3>Create Floor</h3>
          <select id="buildingForFloor"></select>
          <input id="newFloor" placeholder="Floor name">
          <button id="createFloor">Add Floor</button>
        </div>

        <div>
          <h3>Create Counter</h3>
          <select id="buildingForCounter"></select>
          <select id="floorForCounter"></select>
          <input id="newCounter" placeholder="Counter name">
          <button id="createCounter">Add Counter</button>
        </div>

        <div>
          <h3>Create User (Firestore doc only)</h3>
          <input id="uidNew" placeholder="Auth UID">
          <input id="nameNew" placeholder="Name">
          <select id="roleNew"><option value="admin">admin</option><option value="manager">manager</option><option value="staff">staff</option></select>
          <div class="two-col">
            <select id="assignB"></select>
            <select id="assignF"></select>
          </div>
          <select id="assignC"></select>
          <button id="createUserDoc">Create User Doc</button>
        </div>

        <div>
          <h3>Upload Logo (CTS)</h3>
          <input id="logoFile" type="file" accept="image/*">
          <button id="uploadLogo">Upload Logo</button>
          <div class="small">Or place <code>logo.png</code> in same folder as index.html for automatic use.</div>
        </div>
      </div>
    </section>

  </main>


  <!-- PART B: Firebase init, Auth routing, Staff/Manager/Admin logic -->
<script type="module">
/* ========================
   Firebase config & imports
   ======================== */
const firebaseConfig = {
  apiKey: "AIzaSyAXs1fa6r7u8EmvPtbFqhNG5AucSHrxvcI",
  authDomain: "dry-store-inventory.firebaseapp.com",
  projectId: "dry-store-inventory",
  storageBucket: "dry-store-inventory.firebasestorage.app",
  messagingSenderId: "257884008130",
  appId: "1:257884008130:web:5985c82584e286c5a5555b"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  doc,
  getDoc,
  getDocs,
  addDoc,
  setDoc,
  query,
  where,
  orderBy,
  serverTimestamp,
  Timestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ========================
   Small helpers
   ======================== */
const $ = id => document.getElementById(id);
const col = name => collection(db, name);
const fmt = d => {
  if (!d) return "";
  if (typeof d === "string") return d;
  if (d instanceof Date) return d.toISOString().slice(0,10);
  if (d.seconds) return new Date(d.seconds*1000).toISOString().slice(0,10);
  return "";
};
const show = (id) => {
  ["page-login","page-staff","page-manager","page-admin"].forEach(p => $(p).classList.add("hide"));
  $(id).classList.remove("hide");
};

/* ========================
   Logo auto-boot (logo.png or uploaded)
   ======================== */
async function bootLogo() {
  try {
    const resp = await fetch("./logo.png", {cache:'no-store'});
    if (!resp.ok) return;
    const blob = await resp.blob();
    const fr = new FileReader();
    fr.onload = () => {
      localStorage.setItem("cts_logo", fr.result);
      if ($('hdrLogo')) $('hdrLogo').src = fr.result;
    };
    fr.readAsDataURL(blob);
  } catch(e){
    // no-op
  }
}
bootLogo();

$('uploadLogo').onclick = ()=>{
  const f = $('logoFile').files?.[0];
  if(!f) return alert('Choose an image first');
  const fr = new FileReader();
  fr.onload = ()=>{
    localStorage.setItem("cts_logo", fr.result);
    if ($('hdrLogo')) $('hdrLogo').src = fr.result;
    alert('Logo uploaded and saved');
  };
  fr.readAsDataURL(f);
};

/* ========================
   Login handler
   ======================== */
$('loginForm').onsubmit = async (e) => {
  e.preventDefault();
  try {
    await signInWithEmailAndPassword(auth, $('loginEmail').value.trim(), $('loginPassword').value);
  } catch(err) {
    console.error(err);
    alert('Sign in failed: ' + (err.message || err));
  }
};

/* ========================
   Auth state & routing
   ======================== */
onAuthStateChanged(auth, async (user) => {
  if(!user){
    // signed out
    if ($('authArea')) $('authArea').innerHTML = '';
    show('page-login');
    return;
  }

  // read Firestore profile document - must exist and id == auth.uid
  const profileSnap = await getDoc(doc(db,'users',user.uid));
  if (!profileSnap.exists()) {
    alert('User profile not found in Firestore. Create users/{uid} document (uid must match Auth). Logging out.');
    await signOut(auth);
    return;
  }
  const profile = profileSnap.data();
  profile.uid = user.uid;

  // show small auth area with logout
  if ($('authArea')) {
    $('authArea').innerHTML = `<span style="font-size:13px;">${profile.name || user.email} (${profile.role})</span>
      <button id="btnLogout" class="btn-ghost" style="margin-left:8px">Logout</button>`;
    $('btnLogout').onclick = async ()=> { await signOut(auth); };
  }

  // route to appropriate role page
  try {
    if (profile.role === 'admin') {
      await initAdmin(profile);
      show('page-admin');
    } else if (profile.role === 'manager') {
      await initManager(profile);
      show('page-manager');
    } else {
      await initStaff(profile);
      show('page-staff');
    }
  } catch(err) {
    console.error('Routing init error', err);
    alert('Initialization error: ' + (err.message || err));
  }
});

/* ========================
   STAFF: create entry + last7 view
   ======================== */
async function initStaff(profile) {
  // show assigned info
  if ($('staffAssignedInfo')) {
    const a = profile.assigned || {};
    $('staffAssignedInfo').innerHTML = `<div class="small">Assigned: Building <strong>${a.buildingId||'-'}</strong>, Floor <strong>${a.floorId||'-'}</strong>, Counter <strong>${a.counterId||'-'}</strong></div>`;
  }

  // form submit
  $('entryForm').onsubmit = async (e) => {
    e.preventDefault();
    const f = e.target;
    // build entry
    const entry = {
      createdBy: profile.uid,
      buildingId: profile.assigned?.buildingId || '',
      floorId: profile.assigned?.floorId || '',
      counterId: profile.assigned?.counterId || '',

      item: f.item.value.trim(),
      batchNo: f.batchNo.value.trim(),
      receivingDate: f.receivingDate.value,
      mfgDate: f.mfgDate.value,
      expiryDate: f.expiryDate.value,
      shelfLife: f.shelfLife.value ? Number(f.shelfLife.value) : null,
      stockQty: f.stockQty.value ? Number(f.stockQty.value) : 0,
      remarks: f.remarks.value || '',

      createdAt: serverTimestamp(),
      // client side TTL for staff visibility (ISO string) — server-side CF recommended later
      visibleToStaffUntil: new Date(Date.now() + 7*24*60*60*1000).toISOString()
    };

    try {
      await addDoc(col('entries'), entry);
      f.reset();
      await loadStaffTable(profile.assigned?.counterId);
    } catch(err) {
      console.error(err);
      alert('Failed to save entry: ' + (err.message||err));
    }
  };

  $('btnReset').onclick = ()=> $('entryForm').reset();

  await loadStaffTable(profile.assigned?.counterId);
}

async function loadStaffTable(counterId) {
  const tbody = $('staffTable').querySelector('tbody');
  tbody.innerHTML = '';

  if(!counterId) {
    tbody.innerHTML = `<tr><td colspan="9">No counter assigned</td></tr>`;
    return;
  }

  // query last 7 days for this counter
  const sevenAgo = Timestamp.fromMillis(Date.now() - 7*24*60*60*1000);
  const q = query(col('entries'), where('counterId','==',counterId), where('createdAt','>=', sevenAgo), orderBy('createdAt','desc'));
  try {
    const snap = await getDocs(q);
    let i = 1;
    snap.forEach(docSnap => {
      const r = docSnap.data();
      tbody.innerHTML += `<tr>
        <td>${i++}</td>
        <td>${r.item||''}</td>
        <td>${r.batchNo||''}</td>
        <td>${fmt(r.receivingDate)}</td>
        <td>${fmt(r.mfgDate)}</td>
        <td>${fmt(r.expiryDate)}</td>
        <td>${r.shelfLife||''}</td>
        <td>${r.stockQty||''}</td>
        <td>${r.remarks||''}</td>
      </tr>`;
    });
  } catch(err) {
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="9">Error loading entries</td></tr>`;
  }
}

/* ========================
   MANAGER: view & export
   ======================== */
async function initManager(profile) {
  // manager actions
  $('mgrView').onclick = async () => loadManagerTable(profile);
  $('mgrCSV').onclick = () => exportTableCSV('mgrTable', 'manager-export.csv');
  $('mgrCTS').onclick = async () => {
    await loadManagerTable(profile);
    // export function is defined in Part C
    if (window.exportCTS_PDF) await window.exportCTS_PDF('mgrTable', 'CTS-Manager.pdf', { title: 'Dry Store CTS - Manager' });
    else alert('CTS export not loaded yet.');
  };

  // pre-load manager table once
  await loadManagerTable(profile);
}

async function loadManagerTable(profile) {
  const tbody = $('mgrTable').querySelector('tbody');
  tbody.innerHTML = '';

  // Manager is allowed to see only their assigned building/floor/counter per rules
  const a = profile.assigned || {};
  if (!a.buildingId) { tbody.innerHTML = `<tr><td colspan="10">Manager has no assigned building</td></tr>`; return; }

  try {
    const q = query(col('entries'),
                    where('buildingId','==', a.buildingId),
                    where('floorId','==', a.floorId),
                    where('counterId','==', a.counterId),
                    orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    const from = $('mgrFrom').value ? new Date($('mgrFrom').value) : null;
    const to = $('mgrTo').value ? new Date($('mgrTo').value) : null;

    let i = 1;
    snap.forEach(d => {
      const r = d.data();
      const created = r.createdAt?.toDate ? r.createdAt.toDate() : null;
      if (from && created && created < from) return;
      if (to && created && created > to) return;
      tbody.innerHTML += `<tr>
        <td>${i++}</td>
        <td>${r.item||''}</td><td>${r.batchNo||''}</td><td>${fmt(r.receivingDate)}</td>
        <td>${fmt(r.mfgDate)}</td><td>${fmt(r.expiryDate)}</td><td>${r.shelfLife||''}</td>
        <td>${r.stockQty||''}</td><td>${r.remarks||''}</td><td>${r.createdBy||''}</td>
      </tr>`;
    });
  } catch(err) {
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="10">Error loading entries</td></tr>`;
  }
}

/* ========================
   ADMIN: infra, users, view & export
   ======================== */
async function initAdmin(profile) {
  // wire actions
  $('admView').onclick = () => loadAdminTable();
  $('admCSV').onclick = () => exportTableCSV('admTable','admin-export.csv');
  $('admCTS').onclick = async () => {
    await loadAdminTable();
    if (window.exportCTS_PDF) await window.exportCTS_PDF('admTable','CTS-Admin.pdf',{ title:'Dry Store CTS - Admin' });
    else alert('CTS export not loaded yet.');
  };

  $('createBuilding').onclick = async () => {
    const name = $('newBuilding').value.trim();
    if(!name) return alert('Enter building name');
    try {
      await addDoc(col('buildings'), { name, createdAt: serverTimestamp() });
      $('newBuilding').value = '';
      await refreshInfraSelects();
    } catch(err){ console.error(err); alert('Failed to create building'); }
  };

  $('createFloor').onclick = async () => {
    const b = $('buildingForFloor').value;
    const name = $('newFloor').value.trim();
    if(!b || !name) return alert('Select building and floor name');
    try {
      await addDoc(col('floors'), { buildingId: b, name, createdAt: serverTimestamp() });
      $('newFloor').value = '';
      await refreshInfraSelects();
    } catch(err){ console.error(err); alert('Failed to create floor'); }
  };

  $('createCounter').onclick = async () => {
    const b = $('buildingForCounter').value;
    const f = $('floorForCounter').value;
    const name = $('newCounter').value.trim();
    if(!b || !f || !name) return alert('Complete building, floor and name');
    try {
      await addDoc(col('counters'), { buildingId: b, floorId: f, name, createdAt: serverTimestamp() });
      $('newCounter').value = '';
      await refreshInfraSelects();
    } catch(err){ console.error(err); alert('Failed to create counter'); }
  };

  $('createUserDoc').onclick = async () => {
    const uid = $('uidNew').value.trim();
    const name = $('nameNew').value.trim();
    const role = $('roleNew').value;
    if(!uid || !name) return alert('Provide UID and name');
    const assigned = {
      buildingId: $('assignB').value || '',
      floorId: $('assignF').value || '',
      counterId: $('assignC').value || ''
    };
    try {
      await setDoc(doc(db,'users',uid), { name, role, assigned, createdAt: serverTimestamp() });
      alert('User doc created. Make sure Auth account with same UID exists.');
      $('uidNew').value=''; $('nameNew').value='';
    } catch(err){ console.error(err); alert('Failed to create user doc'); }
  };

  // initial infra load
  await refreshInfraSelects();
  await loadAdminTable();
}

async function refreshInfraSelects(){
  try {
    const bSnap = await getDocs(col('buildings'));
    const fSnap = await getDocs(col('floors'));
    const cSnap = await getDocs(col('counters'));

    const bOpts = bSnap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('');
    const fOpts = fSnap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('');
    const cOpts = cSnap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('');

    $('admBuilding').innerHTML = `<option value="">All</option>` + bOpts;
    $('admFloor').innerHTML = `<option value="">All</option>` + fOpts;
    $('admCounter').innerHTML = `<option value="">All</option>` + cOpts;

    $('buildingForFloor').innerHTML = bOpts;
    $('buildingForCounter').innerHTML = bOpts;
    $('floorForCounter').innerHTML = fOpts;

    $('assignB').innerHTML = `<option value=""></option>` + bOpts;
    $('assignF').innerHTML = `<option value=""></option>` + fOpts;
    $('assignC').innerHTML = `<option value=""></option>` + cOpts;
  } catch(err) {
    console.error(err);
    alert('Failed to load infrastructure lists');
  }
}

async function loadAdminTable(){
  const tbody = $('admTable').querySelector('tbody');
  tbody.innerHTML = '';

  try {
    const snap = await getDocs(query(col('entries'), orderBy('createdAt','desc')));
    const bFilter = $('admBuilding').value || null;
    const fFilter = $('admFloor').value || null;
    const cFilter = $('admCounter').value || null;
    const from = $('admFrom').value ? new Date($('admFrom').value) : null;
    const to = $('admTo').value ? new Date($('admTo').value) : null;

    let i = 1;
    snap.forEach(d => {
      const r = d.data();
      const created = r.createdAt?.toDate ? r.createdAt.toDate() : null;
      if (bFilter && r.buildingId !== bFilter) return;
      if (fFilter && r.floorId !== fFilter) return;
      if (cFilter && r.counterId !== cFilter) return;
      if (from && created && created < from) return;
      if (to && created && created > to) return;

      tbody.innerHTML += `<tr>
        <td>${i++}</td>
        <td>${r.item||''}</td>
        <td>${r.batchNo||''}</td>
        <td>${fmt(r.receivingDate)}</td>
        <td>${fmt(r.mfgDate)}</td>
        <td>${fmt(r.expiryDate)}</td>
        <td>${r.shelfLife||''}</td>
        <td>${r.stockQty||''}</td>
        <td>${r.remarks||''}</td>
        <td>${r.createdBy||''}</td>
        <td>${r.buildingId||''}</td>
        <td>${r.floorId||''}</td>
        <td>${r.counterId||''}</td>
      </tr>`;
    });
  } catch(err) {
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="13">Error loading entries</td></tr>`;
  }
}

/* expose exportTableCSV for Part C */
window.exportTableCSV = (tableId, filename) => {
  // simple CSV helper (Part C defines wrapper too)
  const rows = Array.from(document.getElementById(tableId).rows);
  const csv = rows.map(r => Array.from(r.cells).map(c => `"${c.innerText.replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
};

</script>



<!-- PART C: CTS PDF EXPORT, CSV EXPORT, CLOSE HTML -->
<script type="module">
/* ============================================================
   CSV EXPORT (already exposed in Part B but full version here)
============================================================ */
export function exportTableCSV(tableId, filename) {
  const table = document.getElementById(tableId);
  const rows = [...table.rows];
  const csv = rows
    .map(row =>
      [...row.cells]
      .map(cell => `"${cell.innerText.replace(/"/g, '""')}"`)
      .join(",")
    )
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
}


/* ============================================================
   CTS PDF EXPORT (A4 Landscape, Exact Format)
============================================================ */
export async function exportCTS_PDF(tableId, filename, options={}) {

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: "a4",
  });

  const pageW = doc.internal.pageSize.getWidth();
  const margin = 10;

  let title = options.title || "Dry Store Stock Record — CTS Format";
  const releaseText = "Release ID: QCAG-DSSR | Ver 1.0";

  /* ------------------------------------------------------------
     LOAD STORED LOGO (from upload or from logo.png)
  ------------------------------------------------------------ */
  let logo = localStorage.getItem("cts_logo");

  /* ------------------------------------------------------------
     HEADER BLOCK
  ------------------------------------------------------------ */
  let y = 10;
  doc.setFillColor(245,245,245);
  doc.rect(margin, y, pageW - margin*2, 28, "F");

  // Draw Logo (if not present, draw placeholder)
  const logoX = margin + 3;
  const logoY = y + 4;
  const logoW = 35;
  const logoH = 20;

  if (logo) {
    try {
      doc.addImage(logo, "PNG", logoX, logoY, logoW, logoH);
    } catch(e){
      try { doc.addImage(logo, "JPEG", logoX, logoY, logoW, logoH); }
      catch(err){
        doc.rect(logoX, logoY, logoW, logoH);
        doc.text("LOGO", logoX+8, logoY+12);
      }
    }
  } else {
    doc.rect(logoX, logoY, logoW, logoH);
    doc.text("LOGO", logoX+8, logoY+12);
  }

  // Title + release text
  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text(title, margin + logoW + 10, y + 10);

  doc.setFont("helvetica","normal");
  doc.setFontSize(9);
  doc.text(releaseText, margin + logoW + 10, y + 17);

  // Right side meta info
  const metaX = pageW - 110;
  doc.text("Date: " + new Date().toLocaleDateString(), metaX, y + 8);
  doc.text("Vendor: ____________________", metaX, y + 14);
  doc.text("Vendor Supervisor: ____________________", metaX, y + 20);

  // Next block y
  y += 34;


  /* ------------------------------------------------------------
     EXTRACT TABLE DATA FROM HTML
  ------------------------------------------------------------ */
  const tbl = document.getElementById(tableId);
  const trs = [...tbl.tBodies[0].rows];

  const rows = trs.map((tr, i) => {
    const cells = [...tr.cells].map(c => c.innerText.trim());
    return {
      sno: i+1,
      item: cells[1] || "",
      batchNo: cells[2] || "",
      receivingDate: cells[3] || "",
      mfgDate: cells[4] || "",
      expiryDate: cells[5] || "",
      shelfLife: cells[6] || "",
      stockQty: cells[7] || "",
      remarks: cells[8] || ""
    };
  });

  /* ------------------------------------------------------------
     COLUMN WIDTH DEFINITIONS (CTS standard)
  ------------------------------------------------------------ */
  const columns = [
    { header: "S.No",          dataKey: "sno",          width: 10 },
    { header: "Item",          dataKey: "item",         width: 60 },
    { header: "Batch No",      dataKey: "batchNo",      width: 30 },
    { header: "Receiving Date",dataKey: "receivingDate",width: 28 },
    { header: "Mfg Date",      dataKey: "mfgDate",      width: 28 },
    { header: "Expiry Date",   dataKey: "expiryDate",   width: 28 },
    { header: "Shelf Life",    dataKey: "shelfLife",    width: 20 },
    { header: "Stock Qty",     dataKey: "stockQty",     width: 20 },
    { header: "Remarks",       dataKey: "remarks",      width: 60 },
  ];

  /* ------------------------------------------------------------
     RENDER AUTOTABLE
  ------------------------------------------------------------ */
  doc.autoTable({
    startY: y,
    head: [columns.map(c => c.header)],
    body: rows.map(r => columns.map(c => r[c.dataKey])),
    styles: { fontSize: 9, cellPadding: 3 },
    headStyles: { fillColor:[220,220,220], textColor:40, fontStyle:"bold" },
    margin: { left: margin, right: margin },
    tableWidth: pageW - margin*2,
    columnStyles: columns.reduce((acc, c, i) => {
      acc[i] = { cellWidth: c.width };
      return acc;
    },{}),

    didDrawPage: (data) => {
      const pageH = doc.internal.pageSize.getHeight();
      const footerY = pageH - 18;

      doc.setFontSize(9);
      doc.text("Vendor POC: ____________________", margin, footerY);
      doc.text("Verified by F&B Team: ____________________", margin + 95, footerY);

      doc.setFontSize(8);
      doc.text("Generated: " + new Date().toLocaleString(), margin, pageH - 6);
    }
  });

  doc.save(filename);
}


/* ============================================================
   Hook PDF export into global window (Admin & Manager use it)
============================================================ */
window.exportCTS_PDF = exportCTS_PDF;
window.exportTableCSV = exportTableCSV;
</script>

</body>
</html>
  
