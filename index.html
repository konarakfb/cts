<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Konarak F&B ‚Äî Dry Store</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap (for layout and responsive sidebar) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--nav-bg:#0f2b39;--nav-color:#fff;--accent:#0b63d6}
    body {font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#f4f6f8; margin:0;}
    .app {display:flex; min-height:100vh;}
    .sidebar {width:260px;background:linear-gradient(180deg,var(--nav-bg),#07202a);color:var(--nav-color);padding:20px 12px;box-shadow:2px 0 6px rgba(0,0,0,0.08);}
    .sidebar .brand {font-weight:700;font-size:20px;text-align:left;padding:6px 14px;margin-bottom:12px;}
    .sidebar .navbtn {display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:8px;color:var(--nav-color);border:none;background:transparent;width:100%;text-align:left}
    .sidebar .navbtn.active, .sidebar .navbtn:hover {background:rgba(255,255,255,0.06)}
    .main {flex:1;padding:18px;overflow:auto}
    header.topbar{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:12px}
    .card-panel{background:white;border-radius:8px;padding:14px;box-shadow:0 6px 18px rgba(15,20,30,0.06)}
    .table-wrapper{overflow:auto;border-radius:6px;margin-top:12px}
    .small-muted{font-size:13px;color:#666}
    /* responsive */
    @media(max-width:900px){
      .sidebar{position:fixed;left:-100%;top:0;height:100%;z-index:50;transition:left .25s; width:240px}
      .sidebar.open{left:0}
      .main{padding:12px}
      .sidebar-toggle{display:inline-block}
    }
    @media(min-width:901px){
      .sidebar-toggle{display:none}
    }
    /* form boxes for staff entries (vertical) */
    .form-vertical input, .form-vertical select {margin-bottom:8px}
    .logo-small{height:36px;margin-bottom:10px}
    .debug {white-space:pre-wrap; font-family:monospace; font-size:12px; max-height:120px; overflow:auto; background:#111;color:#bfbfbf;padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <img src="" id="logoImg" style="height:28px;display:inline-block;vertical-align:middle;margin-right:8px" alt="">
        <span style="vertical-align:middle">Konarak</span>
      </div>

      <div class="d-grid gap-1">
        <button class="navbtn active" data-target="home" id="btnHome">üè† Home</button>
        <button class="navbtn" data-target="data" id="btnData">üìä Data</button>
        <button class="navbtn" data-target="users" id="btnUsers">üë• Users</button>
        <button class="navbtn" data-target="buildings" id="btnBuildings">üè¢ Buildings</button>
        <button class="navbtn" data-target="floors" id="btnFloors">üìê Floors</button>
        <button class="navbtn" data-target="counters" id="btnCounters">üçΩÔ∏è Counters</button>
        <button class="navbtn" data-target="entries" id="btnEntries">üìÅ Entries</button>
        <hr style="border-color:rgba(255,255,255,0.06);margin:10px 0">
        <button class="navbtn" id="btnLogout" style="color:#ff6b6b">Logout</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
          <button class="btn btn-sm btn-outline-secondary sidebar-toggle" id="toggleSidebar">‚ò∞</button>
          <div>
            <h3 id="pageTitle" style="margin:0">Admin Dashboard</h3>
            <div class="small-muted">Konarak F&B ‚Äî Dry Store</div>
          </div>
        </div>
        <div>
          <strong id="currentUserLabel">Not signed in</strong>
        </div>
      </header>

      <!-- Pages -->
      <section id="pageHome" class="card-panel">
        <h4>Welcome</h4>
        <div id="homeContent">
          <div class="row">
            <div class="col-md-4">
              <div class="card-panel">
                <h6 class="small-muted">Totals</h6>
                <div>Buildings: <span id="statBuildings">0</span></div>
                <div>Floors: <span id="statFloors">0</span></div>
                <div>Counters: <span id="statCounters">0</span></div>
                <div>Users: <span id="statUsers">0</span></div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card-panel">
                <h6 class="small-muted">Recent Entries (last 7 days)</h6>
                <div id="recentEntries" class="table-wrapper"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="pageData" class="card-panel" style="display:none">
        <h5>Data ‚Äî filter & export</h5>
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="small-muted">Building</label>
            <select id="filterBuilding" class="form-select"><option value="all">All</option></select>
          </div>
          <div class="col-md-2">
            <label class="small-muted">Floor</label>
            <select id="filterFloor" class="form-select"><option value="all">All</option></select>
          </div>
          <div class="col-md-2">
            <label class="small-muted">Counter</label>
            <select id="filterCounter" class="form-select"><option value="all">All</option></select>
          </div>
          <div class="col-md-2">
            <label class="small-muted">From</label>
            <input id="filterFrom" type="date" class="form-control" />
          </div>
          <div class="col-md-2">
            <label class="small-muted">To</label>
            <input id="filterTo" type="date" class="form-control" />
          </div>
          <div class="col-md-1">
            <button id="btnFilter" class="btn btn-primary w-100">Apply</button>
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button id="btnExportPdf" class="btn btn-outline-secondary">Export PDF</button>
          <button id="btnExportXlsx" class="btn btn-outline-secondary">Export Excel</button>
          <button id="btnClearFilters" class="btn btn-outline-secondary">Clear</button>
        </div>

        <div id="dataTable" class="table-wrapper mt-3"></div>
      </section>

      <section id="pageUsers" class="card-panel" style="display:none">
        <h5>Users</h5>
        <div class="row g-2 align-items-end">
          <div class="col-md-3"><input id="newUserEmail" placeholder="email" class="form-control" /></div>
          <div class="col-md-3"><input id="newUserPassword" placeholder="password" class="form-control" /></div>
          <div class="col-md-2"><select id="newUserRole" class="form-select"><option value="counter">Counter</option><option value="manager">Manager</option><option value="admin">Admin</option></select></div>
          <div class="col-md-2"><select id="newUserBuilding" class="form-select"><option value="">Building</option></select></div>
          <div class="col-md-2"><select id="newUserFloor" class="form-select"><option value="">Floor</option></select></div>
          <div class="col-md-2"><select id="newUserCounter" class="form-select"><option value="">Counter</option></select></div>
          <div class="col-md-1"><button id="btnCreateUser" class="btn btn-success">Create</button></div>
        </div>

        <div id="usersList" class="mt-3 table-wrapper"></div>
      </section>

      <section id="pageBuildings" class="card-panel" style="display:none">
        <h5>Buildings</h5>
        <div class="row g-2 align-items-end">
          <div class="col-md-4"><input id="newBuildingName" placeholder="Building name" class="form-control" /></div>
          <div class="col-md-2"><button id="btnCreateBuilding" class="btn btn-primary">Create</button></div>
        </div>
        <div id="buildingsList" class="mt-3 table-wrapper"></div>
      </section>

      <section id="pageFloors" class="card-panel" style="display:none">
        <h5>Floors</h5>
        <div class="row g-2 align-items-end">
          <div class="col-md-3"><select id="selBuildingForFloor" class="form-select"><option value="">Select building</option></select></div>
          <div class="col-md-3"><input id="newFloorName" placeholder="Floor name" class="form-control" /></div>
          <div class="col-md-2"><button id="btnCreateFloor" class="btn btn-primary">Create Floor</button></div>
        </div>
        <div id="floorsList" class="mt-3 table-wrapper"></div>
      </section>

      <section id="pageCounters" class="card-panel" style="display:none">
        <h5>Counters</h5>
        <div class="row g-2 align-items-end">
          <div class="col-md-3"><select id="selBuildingForCounter" class="form-select"><option value="">Building</option></select></div>
          <div class="col-md-3"><select id="selFloorForCounter" class="form-select"><option value="">Floor</option></select></div>
          <div class="col-md-3"><input id="newCounterName" placeholder="Counter name" class="form-control" /></div>
          <div class="col-md-2"><button id="btnCreateCounter" class="btn btn-primary">Create Counter</button></div>
        </div>
        <div id="countersList" class="mt-3 table-wrapper"></div>
      </section>

      <section id="pageEntries" class="card-panel" style="display:none">
        <h5>Entries (Admin view)</h5>
        <div id="entriesTable" class="table-wrapper"></div>
      </section>

      <!-- Staff / Manager views included in same file; will redirect based on role -->
      <section id="pageStaff" class="card-panel" style="display:none">
        <h5>Staff ‚Äî Dry Store Entry</h5>
        <div class="row g-2">
          <div class="col-md-4"><label>Building</label><select id="staffBuilding" class="form-select" disabled></select></div>
          <div class="col-md-4"><label>Floor</label><select id="staffFloor" class="form-select" disabled></select></div>
          <div class="col-md-4"><label>Counter</label><select id="staffCounter" class="form-select" disabled></select></div>
        </div>

        <div class="form-vertical mt-3 card-panel">
          <label>Item</label><input id="item" class="form-control" />
          <label>Batch No</label><input id="batch" class="form-control" />
          <label>Receiving Date</label><input id="receivingDate" type="date" class="form-control" />
          <label>Mfg Date</label><input id="mfgDate" type="date" class="form-control" />
          <label>Expiry Date</label><input id="expiryDate" type="date" class="form-control" />
          <label>Shelf Life</label><input id="shelfLife" class="form-control" />
          <label>Stock Qty</label><input id="qty" type="number" class="form-control" />
          <label>Remarks</label><input id="remarks" class="form-control" />
          <div class="mt-2"><button id="btnSaveEntry" class="btn btn-success">Save</button></div>
        </div>

        <h6 class="mt-3">Your entries (last 7 days)</h6>
        <div id="staffEntries" class="table-wrapper"></div>
      </section>

      <hr />
      <div id="debugPanel" style="display:none">
        <h6>Debug / Status</h6>
        <div id="debugLog" class="debug"></div>
      </div>
    </main>
  </div>

  <!-- Firebase (compat), jsPDF, html2canvas, xlsx -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  /*************************************************************************
   * CONFIG - Use your firebase project config here (from conversation)
   *************************************************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyDFBaRe6jDJwbSoRMpGZiQUB8PNXak0o8E",
    authDomain: "konarak-dry-store.firebaseapp.com",
    projectId: "konarak-dry-store",
    storageBucket: "konarak-dry-store.firebasestorage.app",
    messagingSenderId: "796844296062",
    appId: "1:796844296062:web:addf9694564505f914552f"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  /*************************************************************************
   * Utility / Debug
   *************************************************************************/
  function dbg(msg){
    console.log(msg);
    const el = document.getElementById('debugLog');
    if(el) el.textContent = new Date().toLocaleTimeString() + ' ‚Äî ' + msg + '\n' + el.textContent;
  }
  function showDebug(show){ document.getElementById('debugPanel').style.display = show? 'block':'none'; }

  function el(id){ return document.getElementById(id); }
  function clearChildren(node){ while(node.firstChild) node.removeChild(node.firstChild); }

  /*************************************************************************
   * UI helpers: page switching and sidebar
   *************************************************************************/
  const pages = ['home','data','users','buildings','floors','counters','entries','staff'];
  function showPage(name){
    pages.forEach(p=>{
      const node = document.getElementById('page'+capitalize(p));
      if(node) node.style.display = (p===name? 'block':'none');
    });
    // set active nav
    document.querySelectorAll('.navbtn').forEach(btn=>{
      if(btn.dataset.target === name) btn.classList.add('active'); else btn.classList.remove('active');
    });
    // set title
    const titleMap = { home:'Admin Dashboard', data:'Data', users:'Users', buildings:'Buildings', floors:'Floors', counters:'Counters', entries:'Entries', staff:'Staff' };
    document.getElementById('pageTitle').textContent = titleMap[name] || 'Admin Dashboard';
  }
  function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

  // Sidebar toggling
  (function(){
    const sb = el('sidebar'), toggle = el('toggleSidebar');
    toggle && toggle.addEventListener('click', ()=> sb.classList.toggle('open'));
    document.querySelectorAll('.navbtn').forEach(b=>{
      b.addEventListener('click', ev=>{
        const t = b.dataset.target || b.id.replace('btn','').toLowerCase();
        showPage(t);
        // close sidebar on mobile
        if(window.innerWidth <= 900) sb.classList.remove('open');
      });
    });
    el('btnLogout').addEventListener('click', ()=> auth.signOut());
  })();

  /*************************************************************************
   * Page: Home stats & recent entries
   *************************************************************************/
  async function loadHomeStats(){
    try{
      const [bSnap,fSnap,cSnap,uSnap] = await Promise.all([
        db.collection('buildings').get(),
        db.collection('floors').get(),
        db.collection('counters').get(),
        db.collection('users').get()
      ]);
      el('statBuildings').textContent = bSnap.size;
      el('statFloors').textContent = fSnap.size;
      el('statCounters').textContent = cSnap.size;
      el('statUsers').textContent = uSnap.size;
      // recent entries last 7 days
      const cutoff = new Date(Date.now() - 7*24*60*60*1000).toISOString().slice(0,10);
      const snap = await db.collection('entries').orderBy('timestamp','desc').limit(20).get();
      const rows=[];
      snap.forEach(d=>{
        const data=d.data();
        if(data.date && data.date >= cutoff){
          (data.rows||[]).forEach(r=> rows.push({date:data.date, building:data.building||'', floor:data.floor||'', counter:data.counter||'', item:r.item, qty:r.qty}));
        }
      });
      const container = el('recentEntries'); container.innerHTML='';
      if(rows.length) container.appendChild(makeTable([
        {key:'date',label:'Date'},{key:'building',label:'Bldg'},{key:'floor',label:'Floor'},{key:'counter',label:'Counter'},{key:'item',label:'Item'},{key:'qty',label:'Qty'}
      ], rows));
      else container.textContent = 'No recent entries';
    }catch(err){ dbg('loadHomeStats error: '+err.message); }
  }

  /*************************************************************************
   * UTIL: makeTableFrom columns+rows
   *************************************************************************/
  function makeTable(columns, rows){
    const t = document.createElement('table');
    t.className = 'table table-sm';
    const thead = t.createTHead(); const tr = thead.insertRow();
    columns.forEach(c=>{ const th=document.createElement('th'); th.textContent=c.label; tr.appendChild(th); });
    const tb = t.createTBody();
    rows.forEach(r=>{
      const tr = tb.insertRow();
      columns.forEach(c=>{
        const td = tr.insertCell(); td.textContent = (r[c.key] !== undefined ? r[c.key] : '');
      });
    });
    return t;
  }

  /*************************************************************************
   * Load nodes (buildings,floors,counters) into dropdowns & lists
   *************************************************************************/
  async function refreshAllNodesUI(){
    try{
      // load buildings
      const bSnap = await db.collection('buildings').orderBy('name').get();
      fillSelect('filterBuilding', bSnap, 'name', true);
      fillSelect('newUserBuilding', bSnap, 'name', false);
      fillSelect('selBuildingForFloor', bSnap, 'name', false);
      fillSelect('selBuildingForCounter', bSnap, 'name', false);

      // load floors
      const fSnap = await db.collection('floors').orderBy('name').get();
      fillSelect('filterFloor', fSnap, 'name', true);
      fillSelect('newUserFloor', fSnap, 'name', false);
      fillSelect('selFloorForCounter', fSnap, 'name', false);
      fillSelect('newUserCounter', [], 'name', false); // clear

      // load counters
      const cSnap = await db.collection('counters').orderBy('floor').orderBy('name').get();
      // for filterCounter we put value as floor|||name so admin selects floor first then counter matches
      const csel = el('filterCounter'); if(csel){ csel.innerHTML = ''; csel.appendChild(new Option('All','all')); cSnap.forEach(d=>{ const dt=d.data(); csel.appendChild(new Option(dt.name + ' ('+dt.floor+')', dt.floor+'|||'+dt.name)); }); }
      // fill newUserCounter select too
      const nuCounter = el('newUserCounter'); if(nuCounter){ nuCounter.innerHTML=''; nuCounter.appendChild(new Option('','')); cSnap.forEach(d=>nuCounter.appendChild(new Option(d.data().name,d.data().name))); }

      // lists for admin pages (buildingsList, floorsList, countersList)
      renderBuildingsList(bSnap);
      renderFloorsList(fSnap);
      renderCountersList(cSnap);
    }catch(err){ dbg('refreshAllNodesUI: '+err.message); }
  }

  function fillSelect(id, snapOrArray, field, includeAll){
    const sel = el(id); if(!sel) return;
    sel.innerHTML = '';
    if(includeAll) sel.appendChild(new Option('All','all'));
    if(!snapOrArray) return;
    // If snap
    if(typeof snapOrArray.forEach === 'function'){
      snapOrArray.forEach(d=>{
        const data = (d.data? d.data() : d);
        sel.appendChild(new Option(data[field]||data, data[field]||data));
      });
    } else if(Array.isArray(snapOrArray)){
      snapOrArray.forEach(o=> sel.appendChild(new Option(o[field]||o, o[field]||o)));
    }
  }

  function renderBuildingsList(snap){
    const container = el('buildingsList'); container.innerHTML = '';
    const rows = [];
    (snap.docs || snap).forEach(d=>{
      const data = d.data? d.data(): d;
      rows.push({ id: d.id || data.id, name: data.name });
    });
    if(rows.length){
      const t = makeTable([{key:'name',label:'Building'}], rows);
      // add delete buttons column manually
      const tb = t.tBodies[0];
      const headerRow = t.tHead.rows[0];
      const th = document.createElement('th'); th.textContent = 'Actions'; headerRow.appendChild(th);
      Array.from(tb.rows).forEach((tr,i)=>{
        const td = tr.insertCell();
        const b = document.createElement('button'); b.textContent='Delete'; b.className='btn btn-sm btn-outline-danger';
        const id = rows[i].id;
        b.addEventListener('click', async ()=>{
          if(!confirm('Delete building and its floors/counters?')) return;
          try{
            // delete building doc
            await db.collection('buildings').doc(id).delete();
            // optionally delete floors and counters under this building (cascade)
            const fSnap = await db.collection('floors').where('building','==', rows[i].name).get();
            for(const f of fSnap.docs){ await db.collection('floors').doc(f.id).delete(); }
            const cSnap = await db.collection('counters').where('building','==', rows[i].name).get();
            for(const c of cSnap.docs){ await db.collection('counters').doc(c.id).delete(); }
            dbg('deleted building '+rows[i].name);
            await refreshAllNodesUI();
          }catch(err){ dbg('delete building error: '+err.message); alert('Delete failed: '+err.message); }
        });
        td.appendChild(b);
      });
      container.appendChild(t);
    } else container.textContent = 'No buildings';
  }

  function renderFloorsList(snap){
    const container = el('floorsList'); container.innerHTML='';
    const rows = [];
    (snap.docs || snap).forEach(d=>{
      const data=d.data? d.data(): d;
      rows.push({ id: d.id || data.id, name: data.name, building: data.building || '' });
    });
    if(rows.length){
      const cols = [{key:'name',label:'Floor'},{key:'building',label:'Building'}];
      const t = makeTable(cols, rows);
      const tb = t.tBodies[0];
      const headerRow = t.tHead.rows[0];
      const th = document.createElement('th'); th.textContent = 'Actions'; headerRow.appendChild(th);
      Array.from(tb.rows).forEach((tr,i)=>{
        const td = tr.insertCell();
        const b = document.createElement('button'); b.textContent='Delete'; b.className='btn btn-sm btn-outline-danger';
        const id = rows[i].id;
        b.addEventListener('click', async ()=>{
          if(!confirm('Delete floor? (counters under it will be removed)')) return;
          try{
            await db.collection('floors').doc(id).delete();
            // remove counters under this floor
            const cSnap = await db.collection('counters').where('floor','==', rows[i].name).get();
            for(const c of cSnap.docs) await db.collection('counters').doc(c.id).delete();
            dbg('deleted floor '+rows[i].name);
            await refreshAllNodesUI();
          }catch(err){ dbg('delete floor error: '+err.message); alert('Delete failed: '+err.message); }
        });
        td.appendChild(b);
      });
      container.appendChild(t);
    } else container.textContent = 'No floors';
  }

  function renderCountersList(snap){
    const container = el('countersList'); container.innerHTML='';
    const rows = [];
    (snap.docs || snap).forEach(d=>{
      const data = d.data? d.data(): d;
      rows.push({ id: d.id || data.id, name: data.name, floor: data.floor || '', building: data.building || '' });
    });
    if(rows.length){
      const cols = [{key:'name',label:'Counter'},{key:'floor',label:'Floor'},{key:'building',label:'Building'}];
      const t = makeTable(cols, rows);
      const tb = t.tBodies[0];
      const headerRow = t.tHead.rows[0];
      const th = document.createElement('th'); th.textContent = 'Actions'; headerRow.appendChild(th);
      Array.from(tb.rows).forEach((tr,i)=>{
        const td = tr.insertCell();
        const b = document.createElement('button'); b.textContent='Delete'; b.className='btn btn-sm btn-outline-danger';
        const id = rows[i].id;
        b.addEventListener('click', async ()=>{
          if(!confirm('Delete counter?')) return;
          try{
            await db.collection('counters').doc(id).delete();
            dbg('deleted counter '+rows[i].name);
            await refreshAllNodesUI();
          }catch(err){ dbg('delete counter error: '+err.message); alert('Delete failed: '+err.message); }
        });
        td.appendChild(b);
      });
      container.appendChild(t);
    } else container.textContent = 'No counters';
  }

  /*************************************************************************
   * Admin: Users list, create user (Auth + user doc), delete user doc
   *************************************************************************/
  async function renderUsers(){
    try{
      const snap = await db.collection('users').orderBy('role').get();
      const container = el('usersList'); container.innerHTML='';
      const rows=[];
      snap.forEach(d=>{
        const u = d.data();
        rows.push({ id: d.id, email: u.email, role: u.role, building:u.building||'', floor:u.floor||'', counter:u.counter||''});
      });
      if(!rows.length) { container.textContent = 'No users'; return; }
      const cols = [{key:'email',label:'Email'},{key:'role',label:'Role'},{key:'building',label:'Building'},{key:'floor',label:'Floor'},{key:'counter',label:'Counter'}];
      const t = makeTable(cols, rows);
      const tb = t.tBodies[0]; const headerRow = t.tHead.rows[0];
      const th = document.createElement('th'); th.textContent = 'Actions'; headerRow.appendChild(th);
      Array.from(tb.rows).forEach((tr,i)=>{
        const td = tr.insertCell();
        const del = document.createElement('button'); del.textContent='Delete'; del.className='btn btn-sm btn-outline-danger';
        del.addEventListener('click', async ()=>{
          if(!confirm('Delete user document? This will not remove auth account (you can do that in Firebase console).')) return;
          try{
            await db.collection('users').doc(rows[i].id).delete();
            dbg('deleted user doc '+rows[i].email);
            await renderUsers();
          }catch(err){ dbg('delete user error: '+err.message); alert('Delete failed: '+err.message); }
        });
        td.appendChild(del);
      });
      container.appendChild(t);
    }catch(err){ dbg('renderUsers error: '+err.message); }
  }

  el('btnCreateBuilding').addEventListener('click', async ()=>{
    const name = el('newBuildingName').value.trim(); if(!name) return alert('Enter building name');
    try{ await db.collection('buildings').add({name}); el('newBuildingName').value=''; await refreshAllNodesUI(); } catch(e){ dbg('create building err: '+e.message); }
  });

  el('btnCreateFloor').addEventListener('click', async ()=>{
    const building = el('selBuildingForFloor').value; const name = el('newFloorName').value.trim();
    if(!building || !name) return alert('Select building and enter floor name');
    try{ await db.collection('floors').add({name,building}); el('newFloorName').value=''; await refreshAllNodesUI(); } catch(e){ dbg('create floor err: '+e.message); }
  });

  el('btnCreateCounter').addEventListener('click', async ()=>{
    const building = el('selBuildingForCounter').value; const floor = el('selFloorForCounter').value; const name = el('newCounterName').value.trim();
    if(!building || !floor || !name) return alert('Select building/floor and enter counter name');
    try{ await db.collection('counters').add({name,floor,building}); el('newCounterName').value=''; await refreshAllNodesUI(); } catch(e){ dbg('create counter err: '+e.message); }
  });

  // Create user: uses Firebase Auth REST API to create auth account, then stores users doc with same uid
  el('btnCreateUser').addEventListener('click', async ()=>{
    const email = el('newUserEmail').value.trim();
    const pwd = el('newUserPassword').value.trim();
    const role = el('newUserRole').value;
    const building = el('newUserBuilding').value||'';
    const floor = el('newUserFloor').value||'';
    const counter = el('newUserCounter').value||'';
    if(!email || !pwd) return alert('Provide email and password');
    try{
      // create auth user via REST
      const resp = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`, {
        method:'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({email, password: pwd, returnSecureToken: true})
      });
      const data = await resp.json();
      if(data.error) return alert('Auth create failed: '+JSON.stringify(data.error));
      const uid = data.localId;
      // create users doc
      await db.collection('users').doc(uid).set({
        email, role, building, floor, counter, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      el('newUserEmail').value=''; el('newUserPassword').value='';
      await renderUsers(); await refreshAllNodesUI();
      alert('User created: ' + email + '\nPlease note: This created an auth account. Set password reset if needed.');
    }catch(err){ dbg('create user err: '+err.message); alert('Create user failed: '+err.message); }
  });

  /*************************************************************************
   * Filter & Data table (Admin Data page)
   *************************************************************************/
  el('btnFilter').addEventListener('click', loadFilteredEntries);
  el('btnClearFilters').addEventListener('click', ()=>{
    el('filterBuilding').value='all'; el('filterFloor').value='all'; el('filterCounter').value='all'; el('filterFrom').value=''; el('filterTo').value=''; el('dataTable').innerHTML='';
  });

  async function loadFilteredEntries(){
    try{
      const building = el('filterBuilding').value;
      const floor = el('filterFloor').value;
      const counterVal = el('filterCounter').value;
      const from = el('filterFrom').value;
      const to = el('filterTo').value;
      let q = db.collection('entries').orderBy('timestamp','desc');
      if(building && building!=='all') q = q.where('building','==',building);
      if(floor && floor!=='all') q = q.where('floor','==',floor);
      if(counterVal && counterVal!=='all'){
        // counterVal format is floor|||counterName in our populate
        const parts = counterVal.split('|||');
        if(parts.length===2) {
          q = q.where('counter','==',parts[1]);
        }
      }
      const snap = await q.get();
      const rows = [];
      snap.forEach(d=>{
        const data=d.data();
        // date filter (string compare YYYY-MM-DD)
        if(from && data.date < from) return;
        if(to && data.date > to) return;
        (data.rows||[]).forEach(r=>{
          rows.push({
            date: data.date || '',
            building: data.building || '',
            floor: data.floor || '',
            counter: data.counter || '',
            item: r.item || '',
            batch: r.batch || '',
            receivingDate: r.receivingDate || '',
            mfgDate: r.mfgDate || '',
            expiryDate: r.expiryDate || '',
            shelfLife: r.shelfLife || '',
            stockQty: r.qty || '',
            remarks: r.remarks || '',
            createdBy: data.createdBy || '',
            entryId: d.id
          });
        });
      });
      renderDataTable(rows);
    }catch(err){ dbg('loadFilteredEntries: '+err.message); alert('Load failed: '+err.message); }
  }

  function renderDataTable(rows){
    const container = el('dataTable'); container.innerHTML='';
    const cols = [
      {key:'date',label:'Date'},
      {key:'building',label:'Building'},
      {key:'floor',label:'Floor'},
      {key:'counter',label:'Counter'},
      {key:'item',label:'Items'},
      {key:'batch',label:'Batch No.'},
      {key:'receivingDate',label:'Receiving Date'},
      {key:'mfgDate',label:'Manufacturing Date'},
      {key:'expiryDate',label:'Expiry Date'},
      {key:'shelfLife',label:'Shelf Life'},
      {key:'stockQty',label:'Stock Quantity'},
      {key:'remarks',label:'Remarks'}
    ];
    if(!rows.length){ container.textContent = 'No records found'; return; }
    const t = makeTable(cols, rows);
    container.appendChild(t);
    // save rows globally for export
    window._lastExportRows = rows;
  }

  el('btnExportPdf').addEventListener('click', async ()=>{
    if(!window._lastExportRows || !window._lastExportRows.length) return alert('No data to export. Apply filters first.');
    await exportPdf(window._lastExportRows);
  });
  el('btnExportXlsx').addEventListener('click', ()=>{
    if(!window._lastExportRows || !window._lastExportRows.length) return alert('No data to export. Apply filters first.');
    exportExcel(window._lastExportRows);
  });

  /*************************************************************************
   * PDF & Excel export implementations
   *************************************************************************/
  async function exportPdf(rows){
    // Build an off-screen HTML matching CTS form
    const node = document.createElement('div');
    node.style.width = '1122px';
    node.style.padding = '18px';
    node.style.background = '#fff';
    node.style.position = 'fixed';
    node.style.left = '-9999px';
    // Header mimic: logo left, title, project name, date/vendor lines
    node.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <img src="" id="pdfLogo" style="height:48px" />
        <div style="flex:1">
          <div style="font-weight:700;font-size:16px">Dry Store Stock Record</div>
          <div style="font-size:11px;color:#666">Konarak F&B ‚Äî Dry Store</div>
        </div>
      </div>
      <div style="border:1px solid #222;padding:8px;margin-bottom:8px">
        <div style="display:flex;gap:8px;font-size:12px">
          <div style="flex:1">Date: ____________________</div>
          <div style="flex:2">Vendor Name: ____________________________</div>
          <div style="flex:1">Vendor Supervisor Name: __________________</div>
        </div>
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead>
          <tr>
            <th style="border:1px solid #222;padding:6px">S.No</th>
            <th style="border:1px solid #222;padding:6px">Items</th>
            <th style="border:1px solid #222;padding:6px">Batch No.</th>
            <th style="border:1px solid #222;padding:6px">Receiving Date</th>
            <th style="border:1px solid #222;padding:6px">Manufacturing Date</th>
            <th style="border:1px solid #222;padding:6px">Expiry Date</th>
            <th style="border:1px solid #222;padding:6px">Shelf Life</th>
            <th style="border:1px solid #222;padding:6px">Stock Quantity</th>
            <th style="border:1px solid #222;padding:6px">Remarks</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i)=>`<tr>
            <td style="border:1px solid #bbb;padding:6px">${i+1}</td>
            <td style="border:1px solid #bbb;padding:6px">${escapeHtml(r.item||r.Items||'')}</td>
            <td style="border:1px solid #bbb;padding:6px">${escapeHtml(r.batch||'')}</td>
            <td style="border:1px solid #bbb;padding:6px">${escapeHtml(r.receivingDate||'')}</td>
            <td style="border:1px solid #bbb;padding:6px">${escapeHtml(r.mfgDate||'')}</td>
            <td style="border:1px solid #bbb;padding:6px">${escapeHtml(r.expiryDate||'')}</td>
            <td style="border:1px solid #bbb;padding:6px">${escapeHtml(r.shelfLife||'')}</td>
            <td style="border:1px solid #bbb;padding:6px">${escapeHtml(r.stockQty||'')}</td>
            <td style="border:1px solid #bbb;padding:6px">${escapeHtml(r.remarks||'')}</td>
          </tr>`).join('')}
        </tbody>
      </table>
      <div style="margin-top:12px;display:flex;justify-content:space-between">
        <div>Vendor PoC : ___________________</div>
        <div>Verified by F&B team : ___________________</div>
      </div>
    `;
    document.body.appendChild(node);
    // set logo for pdf to same as page logo
    const logoUrl = document.getElementById('logoImg').getAttribute('data-src') || document.getElementById('logoImg').src || '';
    if(logoUrl) node.querySelector('#pdfLogo').src = logoUrl;
    // render via html2canvas
    try{
      const canvas = await html2canvas(node, { scale:2, useCORS:true });
      const img = canvas.toDataURL('image/png');
      const pdf = new window.jspdf.jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
      const w = pdf.internal.pageSize.getWidth();
      const h = pdf.internal.pageSize.getHeight();
      pdf.addImage(img, 'PNG', 0, 0, w, h);
      pdf.save('DryStore_Record.pdf');
    }catch(e){ dbg('PDF export error: '+e.message); alert('Export failed: '+e.message); }
    document.body.removeChild(node);
  }

  function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  function exportExcel(rows){
    // create sheet: map fields into columns consistent with PDF
    const xrows = rows.map((r,i)=> ({
      'S.No': i+1,
      'Date': r.date||'',
      'Building': r.building||'',
      'Floor': r.floor||'',
      'Counter': r.counter||'',
      'Items': r.item||'',
      'Batch No': r.batch||'',
      'Receiving Date': r.receivingDate||'',
      'Mfg Date': r.mfgDate||'',
      'Expiry Date': r.expiryDate||'',
      'Shelf Life': r.shelfLife||'',
      'Stock Quantity': r.stockQty||'',
      'Remarks': r.remarks||''
    }));
    const ws = XLSX.utils.json_to_sheet(xrows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'DryStore');
    XLSX.writeFile(wb, 'DryStore.xlsx');
  }

  /*************************************************************************
   * Staff entry: save and show last 7 days list
   *************************************************************************/
  el('btnSaveEntry').addEventListener('click', async ()=>{
    try {
      const user = auth.currentUser;
      if(!user) return alert('Not signed in');
      const userDoc = await db.collection('users').doc(user.uid).get();
      if(!userDoc.exists) return alert('User metadata missing');
      const meta = userDoc.data();
      const row = {
        item: el('item').value.trim(),
        batch: el('batch').value.trim(),
        receivingDate: el('receivingDate').value || '',
        mfgDate: el('mfgDate').value || '',
        expiryDate: el('expiryDate').value || '',
        shelfLife: el('shelfLife').value || '',
        qty: el('qty').value || '',
        remarks: el('remarks').value || ''
      };
      if(!row.item) return alert('Enter item name');
      const entry = {
        createdBy: user.uid,
        creatorEmail: user.email,
        building: meta.building||'',
        floor: meta.floor||'',
        counter: meta.counter||'',
        date: new Date().toISOString().slice(0,10),
        rows: [row],
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('entries').add(entry);
      alert('Saved');
      // clear form
      ['item','batch','receivingDate','mfgDate','expiryDate','shelfLife','qty','remarks'].forEach(id=>el(id).value='');
      await loadStaffEntries(user.uid);
    }catch(err){ dbg('saveEntry error: '+err.message); alert('Save failed: '+err.message); }
  });

  async function loadStaffEntries(uid){
    const container = el('staffEntries'); container.innerHTML='';
    const snap = await db.collection('entries').where('createdBy','==',uid).orderBy('timestamp','desc').get();
    const cutoff = new Date(Date.now() - 7*24*60*60*1000).toISOString().slice(0,10);
    const rows = [];
    snap.forEach(d=>{
      const data = d.data();
      if(data.date && data.date < cutoff) return;
      (data.rows || []).forEach(r=>{
        rows.push({
          Date: data.date, Item: r.item, 'Batch No': r.batch, 'Receiving Date': r.receivingDate, 'Mfg Date': r.mfgDate,
          'Expiry Date': r.expiryDate, 'Shelf Life': r.shelfLife, 'Qty': r.qty, 'Remarks': r.remarks
        });
      });
    });
    if(rows.length) container.appendChild(makeTable(Object.keys(rows[0]).map(k=>({key:k,label:k})), rows));
    else container.textContent = 'No entries in last 7 days';
  }

  /*************************************************************************
   * Auth state handling: safe redirect & prevention of accidental auto-login
   *************************************************************************/
  let initialAuthHandled = false;
  auth.onAuthStateChanged(async (user)=>{
    dbg('onAuthStateChanged ‚Üí ' + (user? user.email : 'null'));
    if(!user){
      // not signed in: show admin login page (home remains) but hide staff-specific pages
      el('currentUserLabel').textContent = 'Not signed in';
      // show admin home default and login controls (we keep visible but admin actions require signup)
      showPage('home');
      await refreshAllNodesUI();
      await loadHomeStats();
      initialAuthHandled = true;
      return;
    }
    // If signed in, verify user doc exists and role assigned
    try{
      const udoc = await db.collection('users').doc(user.uid).get();
      if(!udoc.exists){
        // Defensive: new auth session but no metadata -> sign out to avoid accidental access.
        dbg('User doc missing for ' + user.email + ', signing out to avoid accidental access.');
        await auth.signOut();
        alert('Your account is not yet configured in the system. Please ask admin to create your user record.');
        return;
      }
      const meta = udoc.data();
      el('currentUserLabel').textContent = user.email + ' ‚Äî ' + (meta.role || 'user');
      // route based on role
      const role = (meta.role || 'counter').toLowerCase();
      if(role === 'admin'){
        // show admin UI
        showPage('home');
        await refreshAllNodesUI();
        await loadHomeStats();
        await renderUsers();
      } else if(role === 'manager'){
        // manager UI (data filtered by manager floor)
        showPage('data');
        // set filter options and auto apply floor filter
        await refreshAllNodesUI();
        el('filterFloor').value = meta.floor || 'all';
        el('filterBuilding').value = meta.building || 'all';
        el('filterCounter').value = 'all';
        await loadFilteredEntries();
      } else {
        // counter / staff
        showPage('staff');
        // set staff assigned values
        el('staffBuilding').innerHTML = `<option>${meta.building||''}</option>`;
        el('staffFloor').innerHTML = `<option>${meta.floor||''}</option>`;
        el('staffCounter').innerHTML = `<option>${meta.counter||''}</option>`;
        // load last 7 days entries
        await loadStaffEntries(user.uid);
      }
    }catch(err){
      dbg('onAuthStateChanged error: '+err.message);
    }
    initialAuthHandled = true;
  });

  /*************************************************************************
   * Initialization: populate node lists on page load
   *************************************************************************/
  (async function init(){
    // optionally show debug
    // showDebug(true);
    // set default logo (create in assets or replace)
    const logoEl = el('logoImg'); logoEl.src = ''; logoEl.alt = 'konarak';
    // fill lists
    try{ await refreshAllNodesUI(); await loadHomeStats(); } catch(e){ dbg('init err: '+e.message); }
  })();

  /*************************************************************************
   * Simple helper for loading filtered entries into entries page (admin download view)
   *************************************************************************/
  async function loadEntriesForAdmin(){
    const snap = await db.collection('entries').orderBy('timestamp','desc').get();
    const rows = [];
    snap.forEach(d=>{
      const data = d.data();
      (data.rows||[]).forEach(r=>{
        rows.push({
          date: data.date||'', building:data.building||'', floor:data.floor||'', counter:data.counter||'',
          item:r.item||'', batch:r.batch||'', receivingDate:r.receivingDate||'', mfgDate:r.mfgDate||'', expiryDate:r.expiryDate||'', shelfLife:r.shelfLife||'', stockQty:r.qty||'', remarks:r.remarks||''
        });
      });
    });
    const container = el('entriesTable'); container.innerHTML='';
    if(rows.length) container.appendChild(makeTable([
      {key:'date',label:'Date'},{key:'building',label:'Bldg'},{key:'floor',label:'Floor'},{key:'counter',label:'Counter'},
      {key:'item',label:'Item'},{key:'batch',label:'Batch'},{key:'receivingDate',label:'Receiving'},{key:'mfgDate',label:'Mfg'},{key:'expiryDate',label:'Expiry'},
      {key:'shelfLife',label:'Shelf Life'},{key:'stockQty',label:'Qty'},{key:'remarks',label:'Remarks'}
    ], rows));
    window._lastExportRows = rows;
  }

  // Wire up nav to load entries page content
  el('btnEntries').addEventListener('click', async ()=> { await loadEntriesForAdmin(); });

  // prevent accidental page leaving
  // window.addEventListener('beforeunload', (e) => { /* optionally warn */ });

  </script>

  <!-- Bootstrap JS (for some components) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
